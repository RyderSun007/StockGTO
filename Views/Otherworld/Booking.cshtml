@model List<StockGTO.Models.DiyTicketType>
@{
    Layout = null; // ❌ 不套用 Layout
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<div class="container py-5">
    <h2 class="text-center mb-4 fw-bold">🎟 DIY 預約系統（資料庫版）</h2>

    <!-- ✅ 選擇日期 -->
    <div class="mb-4 text-center">
        <label class="form-label">選擇日期</label>
        <input type="date" id="selectedDate" class="form-control w-25 mx-auto"
               value="@DateTime.Today.ToString("yyyy-MM-dd")" />
    </div>

    <!-- ✅ 票種卡片 -->
    <div class="row g-4" id="ticketContainer">
        @foreach (var ticket in Model)
        {
            <div class="col-md-4">
                <div class="card shadow-sm text-center">
                    <img src="@ticket.ImageUrl" class="card-img-top" style="height:200px;object-fit:cover;">
                    <div class="card-body">
                        <h5 class="card-title">@ticket.Name</h5>
                        <p class="text-muted">價格：@ticket.Price 元</p>
                        <select class="form-select mb-2 time-slot" data-id="@ticket.Id">
                            <option>09:00</option>
                            <option>11:00</option>
                            <option>13:00</option>
                            <option>15:00</option>
                            <option>17:00</option>
                            <option>19:00</option>
                        </select>
                        <button class="btn btn-danger w-100 book-btn" data-id="@ticket.Id" data-name="@ticket.Name">
                            立即預約
                        </button>
                        <p class="mt-2">
                            <span class="badge bg-success remaining" data-id="@ticket.Id">
                                剩餘 @ticket.MaxCapacity 人
                            </span>
                        </p>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<!-- ✅ Modal：預約表單 -->
<div class="modal fade" id="bookingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">填寫預約資訊</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="ticketName" class="fw-bold text-primary"></p>
                <input type="hidden" id="modalTicketId">
                <input type="hidden" id="modalTimeSlot">
                <div class="mb-3">
                    <label class="form-label">公司名稱（可空白）</label>
                    <input type="text" class="form-control" id="companyName">
                </div>
                <div class="mb-3">
                    <label class="form-label">姓名</label>
                    <input type="text" class="form-control" id="userName">
                </div>
                <div class="mb-3">
                    <label class="form-label">電話</label>
                    <input type="text" class="form-control" id="userPhone">
                </div>
                <div class="mb-3">
                    <label class="form-label">Email（可空白）</label>
                    <input type="text" class="form-control" id="userEmail">
                </div>
                <div class="mb-3">
                    <label class="form-label">預約人數</label>
                    <input type="number" class="form-control" id="userCount" value="1" min="1">
                </div>
                <div class="mb-3">
                    <label class="form-label">備註</label>
                    <textarea class="form-control" id="userNote" rows="2"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="confirmBooking">確認預約</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const bookingModal = new bootstrap.Modal(document.getElementById('bookingModal'));

    // ✅ 當日期變更時 → 更新剩餘人數
    document.getElementById("selectedDate").addEventListener("change", async function () {
        const date = this.value;
        const res = await fetch(`/Otherworld/GetTicketsByDate?date=${date}`);
        const tickets = await res.json();
        tickets.forEach(ticket => {
            document.querySelector(`.remaining[data-id='${ticket.id}']`).textContent =
                `剩餘 ${ticket.remaining} 人`;
        });
    });

    // ✅ 點「立即預約」 → 開啟 Modal
    document.querySelectorAll(".book-btn").forEach(btn => {
        btn.addEventListener("click", function () {
            const id = this.dataset.id;
            const name = this.dataset.name;
            const timeSlot = document.querySelector(`.time-slot[data-id='${id}']`).value;
            const date = document.getElementById("selectedDate").value;

            document.getElementById("ticketName").textContent =
                `票種：${name}（${date} ${timeSlot}）`;
            document.getElementById("modalTicketId").value = id;
            document.getElementById("modalTimeSlot").value = timeSlot;

            document.getElementById("companyName").value = "";
            document.getElementById("userName").value = "";
            document.getElementById("userPhone").value = "";
            document.getElementById("userEmail").value = "";
            document.getElementById("userCount").value = 1;
            document.getElementById("userNote").value = "";

            bookingModal.show();
        });
    });

    // ✅ 確認送出（含前端驗證）
    document.getElementById("confirmBooking").addEventListener("click", async function () {
        if (!confirm("請再次確認資料是否正確，確定送出？")) return;

        const userName = document.getElementById("userName").value.trim();
        const userPhone = document.getElementById("userPhone").value.trim();
        const userCount = parseInt(document.getElementById("userCount").value);

        if (!userName) {
            alert("❌ 請輸入姓名");
            return;
        }
        if (!userPhone) {
            alert("❌ 請輸入電話");
            return;
        }
        if (isNaN(userCount) || userCount <= 0) {
            alert("❌ 預約人數必須大於 0");
            return;
        }

        const ticketTypeId = parseInt(document.getElementById("modalTicketId").value);
        const timeSlot = document.getElementById("modalTimeSlot").value;
        const date = document.getElementById("selectedDate").value;

        const res = await fetch("/Otherworld/BookTicket", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                ticketTypeId: ticketTypeId,
                date: date,
                timeSlot: timeSlot,
                bookedCount: userCount,
                companyName: document.getElementById("companyName").value.trim(),
                userName: userName,
                userPhone: userPhone,
                email: document.getElementById("userEmail").value.trim(),
                note: document.getElementById("userNote").value.trim()
            })
        });

        const data = await res.json();
        if (data.success) {
            alert("✅ 預約成功！剩餘 " + data.remaining + " 人");
            document.querySelector(`.remaining[data-id='${ticketTypeId}']`).textContent =
                `剩餘 ${data.remaining} 人`;
            bookingModal.hide();
        } else {
            alert("❌ " + data.message);
        }
    });
</script>
