@{
    Layout = "~/Views/Shared/_AzNewsLayout.cshtml"; // ✅ 改版一致！
    ViewData["Title"] = "AJAX 股票列表樣式";
}

<main class="container pt-5">

    <h2 class="fw-bold mb-4">📈 股票即時列表（AJAX 管理版）</h2>

    <!-- 🔍 搜尋欄位 -->
    <div class="input-group mb-4">
        <input type="text" id="searchInput" placeholder="搜尋股票名稱或代號" class="form-control" onkeyup="filterPosts()" />
        <span class="input-group-text"><i class="fas fa-search"></i></span>
    </div>

    <!-- 📊 股票清單表格 -->
    <div class="table-responsive">
        <table class="table table-bordered align-middle text-center" id="ajaxTable">
            <thead class="table-primary">
                <tr>
                    <th>股票資訊</th>
                    <th>新增時間</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="ajaxBody">
                <!-- AJAX 動態載入 -->
            </tbody>
        </table>
    </div>

    <!-- 📝 新增股票資料 -->
    <h3 class="fw-bold mt-5">➕ 新增股票（AJAX送出）</h3>
    <div class="row g-3 mb-5">

        <div class="col-md-4">
            <input id="stockName" placeholder="股票名稱" class="form-control" />
        </div>
        <div class="col-md-4">
            <input id="stockCode" placeholder="股票代號" class="form-control" />
        </div>
        <div class="col-md-4">
            <input id="currentPrice" placeholder="今日價格" class="form-control" />
        </div>
        <div class="col-md-4">
            <input id="yesterdayPrice" placeholder="昨日價格" class="form-control" />
        </div>
        <div class="col-md-4">
            <input id="avgPrice" placeholder="平均價格" class="form-control" />
        </div>
        <div class="col-md-4">
            <input id="eps" placeholder="EPS" class="form-control" />
        </div>
        <div class="col-12">
            <textarea id="description" placeholder="補充說明" class="form-control" rows="3"></textarea>
        </div>

        <div class="col-12 d-grid gap-2">
            <button class="btn btn-success" onclick="submitAjax()">
                <i class="fas fa-plus-circle"></i> 新增股票
            </button>
        </div>

    </div>

</main>

@section Scripts {
    <script>
        console.log("🚀 正在載入股票列表...");

        function loadData() {
            fetch("/ArticlePost/GetAjaxPosts")
                .then(res => res.json())
                .then(posts => {
                    console.log("✅ 資料抓取成功：", posts);
                    posts.forEach(post => appendRow(post));
                });
        }

        function appendRow(post) {
            const row = `
                <tr>
                    <td class="text-start">
                        <strong>${post.stockName}</strong> (${post.stockCode})<br/>
                        📈 今日 ${post.currentPrice} ｜ 昨日 ${post.yesterdayPrice} ｜ 平均 ${post.avgPrice} ｜ EPS ${post.eps}<br/>
                        <small class="text-muted">📝 ${post.description ?? ""}</small>
                    </td>
                    <td>${new Date(post.createdAt).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-info me-1" onclick="editPost(${post.id})">✏️</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deletePost(${post.id})">🗑️</button>
                    </td>
                </tr>`;
            document.getElementById("ajaxBody").innerHTML += row;
        }

        function submitAjax() {
            const data = {
                stockName: document.getElementById("stockName").value,
                stockCode: document.getElementById("stockCode").value,
                currentPrice: parseFloat(document.getElementById("currentPrice").value),
                yesterdayPrice: parseFloat(document.getElementById("yesterdayPrice").value),
                avgPrice: parseFloat(document.getElementById("avgPrice").value),
                eps: parseFloat(document.getElementById("eps").value),
                description: document.getElementById("description").value
            };

            fetch("/ArticlePost/CreateFromAjax", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            })
            .then(res => res.json())
            .then(post => {
                console.log("✅ 成功新增股票：", post);
                appendRow(post);
            });
        }

        function filterPosts() {
            const keyword = document.getElementById("searchInput").value.toLowerCase();
            const rows = document.querySelectorAll("#ajaxTable tbody tr");
            rows.forEach(row => {
                const text = row.innerText.toLowerCase();
                row.style.display = text.includes(keyword) ? "" : "none";
            });
        }

        function editPost(id) {
            alert(`📝 編輯功能未來開放，ID: ${id}`);
        }

        function deletePost(id) {
            alert(`🗑️ 刪除功能未來開放，ID: ${id}`);
        }

        loadData();
    </script>
}
